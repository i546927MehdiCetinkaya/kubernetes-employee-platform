name: Rebuild Frontend with API Fix

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 920120424621.dkr.ecr.eu-west-1.amazonaws.com
  ECR_REPOSITORY: hr-portal-frontend
  EKS_CLUSTER_NAME: innovatech-employee-lifecycle

jobs:
  rebuild-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::920120424621:role/innovatech-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: Build frontend image
        working-directory: ./applications/hr-portal/frontend
        run: |
          echo "=== Building Frontend Image ==="
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest .
          docker tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest \
                     ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          
      - name: Push to ECR
        run: |
          echo "=== Pushing to ECR ==="
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          
      - name: Restart frontend deployment
        run: |
          echo "=== Restarting Frontend Deployment ==="
          kubectl rollout restart deployment/hr-portal-frontend -n hr-portal
          
      - name: Wait for rollout
        run: |
          echo "=== Waiting for Rollout to Complete ==="
          kubectl rollout status deployment/hr-portal-frontend -n hr-portal --timeout=5m
          
      - name: Verify pods
        run: |
          echo "=== Frontend Pods Status ==="
          kubectl get pods -n hr-portal -l app=hr-portal-frontend
          
      - name: Test frontend
        run: |
          echo "=== Testing Frontend ==="
          LB_DNS=$(kubectl get ingress hr-portal -n hr-portal -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "LoadBalancer DNS: $LB_DNS"
          
          echo ""
          echo "Testing frontend root..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://$LB_DNS/ || echo "Request failed"
          
          echo ""
          echo "‚úÖ Frontend rebuilt and deployed successfully!"
          echo "üåê Access your app at: http://$LB_DNS"
