name: Install AWS Load Balancer Controller

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1
  CLUSTER_NAME: innovatech-employee-lifecycle

jobs:
  install-lb-controller:
    name: Install AWS LB Controller
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::920120424621:role/githubrepo
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.4'

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}
          kubectl version --client

      - name: Install AWS Load Balancer Controller
        run: |
          # Add Helm repo
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm repo add eks https://aws.github.io/eks-charts
          helm repo update

          # Create IAM policy if it doesn't exist
          echo "Creating IAM policy..."
          curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.0/docs/install/iam_policy.json
          
          aws iam create-policy \
            --policy-name AWSLoadBalancerControllerIAMPolicy \
            --policy-document file://iam-policy.json 2>/dev/null || echo "Policy already exists"

          # Create service account with IRSA
          eksctl create iamserviceaccount \
            --cluster=${{ env.CLUSTER_NAME }} \
            --namespace=kube-system \
            --name=aws-load-balancer-controller \
            --attach-policy-arn=arn:aws:iam::920120424621:policy/AWSLoadBalancerControllerIAMPolicy \
            --override-existing-serviceaccounts \
            --region ${{ env.AWS_REGION }} \
            --approve || echo "Service account already exists"

          # Install the controller using Helm
          helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=${{ env.CLUSTER_NAME }} \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set region=${{ env.AWS_REGION }} \
            --set vpcId=$(aws eks describe-cluster --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }} --query 'cluster.resourcesVpcConfig.vpcId' --output text) || \
          helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=${{ env.CLUSTER_NAME }} \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set region=${{ env.AWS_REGION }} \
            --set vpcId=$(aws eks describe-cluster --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }} --query 'cluster.resourcesVpcConfig.vpcId' --output text)

      - name: Wait for controller to be ready
        run: |
          echo "Waiting for AWS Load Balancer Controller to be ready..."
          kubectl wait --namespace kube-system \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/name=aws-load-balancer-controller \
            --timeout=120s

      - name: Check controller status
        run: |
          echo "=== Load Balancer Controller Pods ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
          
          echo ""
          echo "=== Controller Logs ==="
          kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller --tail=20

      - name: Check Ingress status
        run: |
          echo "Waiting for Ingress to get ADDRESS..."
          sleep 30
          
          echo "=== Ingress Status ==="
          kubectl get ingress -n hr-portal
          kubectl describe ingress -n hr-portal
